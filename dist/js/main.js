const body=document.body,posters=document.getElementsByClassName("posters")[0],information=document.getElementsByClassName("information")[0],label1=document.getElementsByClassName("label_title")[0],label2=document.getElementsByClassName("label_title")[1],addbox=document.getElementsByClassName("addbox")[0],listbox=document.getElementsByClassName("listbox")[0],mask=document.getElementsByClassName("mask")[0],loading=document.getElementsByClassName("loading")[0],alertbox=document.getElementsByClassName("alertbox")[0],labellist=document.getElementsByTagName("label");let musiclist=[],num=0;music.volume=.5;let volumetimer=null;function Ajax(t){let n;n=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),n.onreadystatechange=function(){var e;200==n.status&&4==n.readyState&&(e="json"==t.type?JSON.parse(n.responseText):"xml"==t.type?responseXML:n.responseText,t.callback(e))};var e="";if("{}"!=JSON.stringify(t.data)){for(var s in t.url+="?",t.data)e+=s+"="+t.data[s]+"&";e=e.slice(0,e.length-1)}"get"==t.method&&(t.url=t.url+e),n.open(t.method,t.url,!0),"post"==t.method?(n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.send(e)):n.send(null)}function getMusiclist(){Ajax({method:"get",url:"http://localhost:1777/getMusiclist",data:null,callback:function(e){musiclist=e},type:"json"})}function durationDo(e){let t=parseInt(e/60),n=e-60*t;return t<10&&(t="0"+t),n<10&&(n="0"+n),`${t}:${n}`}function render(e){var t=`<img src=${e.imagesrc} alt="">`,n=`<p class="song">${e.song}</p>
  <p class="singer">歌手:<span>${e.singer}</span></p>
  <p class="album">专辑:<span>${e.album}</span></p>`;music.src=e.audiosrc,bg.src=e.imagesrc,posters.innerHTML=t,information.innerHTML=n,duration.innerHTML=durationDo(e.duration)}function controlPlay(e){play.classList.remove("active"),musiclist[e]?render(musiclist[e]):(num=0,render(musiclist[num]))}function nextMusic(){num++,controlPlay(num),changelistboxstyle(num)}function lastMusic(){0==num?num=musiclist.length-1:num--,controlPlay(num),changelistboxstyle(num)}function playMusic(){music.paused?(music.play(),play.classList.remove("active")):(music.pause(),play.classList.add("active"))}function volumeChange(e){clearTimeout(volumetimer),volumetimer=setTimeout(function(){music.volume=e.target.value/100},70)}function showLoading(){mask.style.display="block",loading.style.display="block"}function hiddenLoading(){mask.style.display="none",loading.style.display="none"}function closeAlertbox(){alertboxDo("hidden")}function alertboxDo(e,t){"show"===e?(alertbox.style.display="block",alertbox.children[0].innerHTML=t):"hidden"===e&&(alertbox.style.display="none")}function sendFile(e,t){var n=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");n.onreadystatechange=function(){200==n.status&&4==n.readyState&&t(n.response)},n.open("POST","http://localhost:1777/addmusic",!0),n.send(e)}function addMusic(e){var n=addForm.elements.length;let s=new FormData;for(let t=0;t<n;t++){if(!addForm.elements[t].value){for(let e=t;e<n;e++)addForm.elements[e].value||(labellist[e].children[0].classList="rotateA"),setTimeout(function(){labellist[e].children[0].classList=""},1e3);return}"audio"==addForm.elements[t].id||"image"==addForm.elements[t].id?s.append(addForm.elements[t].id,addForm.elements[t].files[0]):s.append(addForm.elements[t].id,addForm.elements[t].value)}showLoading(),sendFile(s,function(e){"succ"===e?(addbox.style.display="none",getMusiclist(),Ajax({method:"get",url:"http://localhost:1777/getMusiclist",data:null,callback:function(e){musiclist=e,renderlistbox()},type:"json"})):alertboxDo("show","err"===e?"上传失败":"音频处理错误"),hiddenLoading()})}function progressUpdata(){var e=(music.currentTime/parseInt(music.duration)*100-100).toFixed(1);progressbar2.style.transform=`translateX(${e}%)`,0<=e&&nextMusic()}function changeTime(e){e=(e.pageX/window.innerWidth).toFixed(4);music.currentTime=music.duration*e,music.play(),play.classList.remove("active")}function audioPickSucc(e){""==audio.value?label1.innerHTML="音频文件":label1.innerHTML=e.target.files[0].name}function imagePickSucc(e){""==image.value?label2.innerHTML="歌曲海报":label2.innerHTML=e.target.files[0].name}function showAddbox(){addbox.style.display="block"}function closeAddbox(){addbox.style.display="none"}function controlShowVolume(){volume.classList.value?volume.classList="":volume.classList="showvolume"}function renderlistbox(){let n="";musiclist.map((e,t)=>{n+=`<div class="musicitem" dataset_index=${t}>${e.song}-${e.singer}</div>`}),listbox.innerHTML=n}function changelistboxstyle(t){let n=document.getElementsByClassName("musicitem");for(let e=0;e<n.length;e++)t==e?n[t].classList="musicitem onplay":n[e].classList="musicitem"}function boxchangsong(e){num=e.target.getAttribute("dataset_index"),controlPlay(num),changelistboxstyle(num)}Ajax({method:"get",url:"http://localhost:1777/getMusiclist",data:null,callback:function(e){render((musiclist=e)[0]),renderlistbox(),changelistboxstyle(0)},type:"json"}),play.onclick=playMusic,next.onclick=nextMusic,last.onclick=lastMusic,volume.oninput=volumeChange,music.ontimeupdate=progressUpdata,progressbar1.onclick=changeTime,addbtn.onclick=addMusic,audio.onchange=audioPickSucc,image.onchange=imagePickSucc,toadd.onclick=showAddbox,closebtn.onclick=closeAddbox,toshowVolume.onclick=controlShowVolume,listbox.onclick=boxchangsong,alertbox.children[1].onclick=closeAlertbox;